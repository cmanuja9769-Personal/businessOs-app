# E-Way Bill API - Complete Backend Documentation

## üìã Overview

This backend implementation provides a complete, production-ready integration with the Government of India's E-Way Bill system. It enables automated generation, management, and tracking of E-Way Bills directly from your inventory-billing application.

---

## üèóÔ∏è Architecture

### Components Created

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ewaybill.types.ts          # TypeScript type definitions
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ewaybill.service.ts        # Core E-Way Bill service
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ewaybill.controller.ts     # Request handlers
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ewaybill.routes.ts         # API route definitions
‚îÇ   ‚îî‚îÄ‚îÄ queues/
‚îÇ       ‚îî‚îÄ‚îÄ ewaybill-generation.queue.ts # Async processing queue
```

---

## üîê Environment Configuration

Add these variables to your `.env` file:

```env
# E-Way Bill Configuration
EWAYBILL_API_URL=https://api.ewaybillgst.gov.in
EWAYBILL_USERNAME=your-username
EWAYBILL_PASSWORD=your-password
EWAYBILL_GSTIN=your-gstin
```

### Getting E-Way Bill API Credentials

1. **Register on E-Way Bill Portal**
   - Visit: https://ewaybillgst.gov.in
   - Click on "Registration" ‚Üí "As Taxpayer"
   - Complete registration with your GSTIN

2. **Generate API Credentials**
   - Login to portal
   - Go to: Registration ‚Üí For API
   - Enter your domain name and static IP (if available)
   - System will generate: Client_Id, Client_Secret, Username, Password
   - Save these credentials securely

3. **Test Environment**
   - Sandbox URL: `https://preprod-api.ewaybillgst.gov.in`
   - Use sandbox for testing before production

---

## üöÄ Features Implemented

### 1. **E-Way Bill Generation**
- ‚úÖ Automatic E-Way Bill generation from invoices
- ‚úÖ Support for inter-state and intra-state supplies
- ‚úÖ HSN code validation
- ‚úÖ Automatic tax calculation (CGST/SGST/IGST)
- ‚úÖ Multiple transport modes (Road, Rail, Air, Ship)
- ‚úÖ Threshold check (‚Çπ50,000 for goods)

### 2. **Vehicle Management**
- ‚úÖ Update vehicle number
- ‚úÖ Multiple update reasons (Breakdown, Transhipment, etc.)
- ‚úÖ Transport mode updates
- ‚úÖ Vehicle change tracking

### 3. **E-Way Bill Operations**
- ‚úÖ Cancel E-Way Bill (within 24 hours)
- ‚úÖ Extend validity period
- ‚úÖ Reject E-Way Bills (for recipients)
- ‚úÖ Get E-Way Bill details
- ‚úÖ Query E-Way Bills generated by others

### 4. **Consolidated E-Way Bills**
- ‚úÖ Generate consolidated E-Way Bill for multiple shipments
- ‚úÖ Trip sheet management
- ‚úÖ Multi-bill tracking

### 5. **Async Processing**
- ‚úÖ BullMQ queue for background processing
- ‚úÖ Retry mechanism (3 attempts with exponential backoff)
- ‚úÖ Job status tracking
- ‚úÖ Progress updates
- ‚úÖ Error handling and logging

---

## üì° API Endpoints

### Base URL
```
http://localhost:3001/api/v1/e-waybill
```

### Authentication
All endpoints require JWT authentication:
```
Authorization: Bearer <your-jwt-token>
```

---

### 1. Generate E-Way Bill

**Endpoint:** `POST /e-waybill/generate`

**Request Body:**
```json
{
  "invoiceId": "uuid-of-invoice"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "ewbNo": 123456789012,
    "ewayBillDate": "28/12/2024",
    "validUpto": "11/01/2025",
    "alert": "E-Way Bill generated successfully"
  },
  "message": "E-Way Bill generated successfully"
}
```

**Example cURL:**
```bash
curl -X POST http://localhost:3001/api/v1/e-waybill/generate \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"invoiceId": "your-invoice-id"}'
```

**Error Codes:**
- `400` - Invalid invoice data or missing required fields
- `404` - Invoice not found
- `409` - E-Way Bill already exists for this invoice
- `422` - Invoice value below ‚Çπ50,000 (not required)

---

### 2. Get E-Way Bill Details

**Endpoint:** `GET /e-waybill/:ewbNo`

**Response:**
```json
{
  "success": true,
  "data": {
    "ewbNo": 123456789012,
    "ewayBillDate": "28/12/2024",
    "genGstin": "27AABCU9603R1ZM",
    "genMode": "WEB",
    "supplyType": "O",
    "docType": "INV",
    "docNo": "INV-2024-001",
    "docDate": "28/12/2024",
    "fromGstin": "27AABCU9603R1ZM",
    "fromTrdName": "ABC Traders",
    "fromPlace": "Mumbai",
    "fromPincode": 400001,
    "fromStateCode": 27,
    "toGstin": "29AABCU9603R1ZN",
    "toTrdName": "XYZ Corporation",
    "toPlace": "Bangalore",
    "toPincode": 560001,
    "toStateCode": 29,
    "totalValue": 50000,
    "totalInvoiceValue": 59000,
    "transporterId": "29AABCU9603R1ZO",
    "transMode": "1",
    "transDistance": 850,
    "vehicleNo": "KA01AB1234",
    "vehicleType": "R",
    "status": "ACT",
    "validUpto": "11/01/2025"
  }
}
```

---

### 3. Update Vehicle Number

**Endpoint:** `POST /e-waybill/update-vehicle`

**Request Body:**
```json
{
  "ewbNo": 123456789012,
  "vehicleNo": "MH12CD5678",
  "fromPlace": "Mumbai",
  "fromState": 27,
  "reasonCode": "2",
  "reasonRem": "Transhipment at warehouse",
  "transMode": "1"
}
```

**Reason Codes:**
- `1` - Breakdown
- `2` - Transhipment
- `3` - Others
- `4` - First Time

**Transport Modes:**
- `1` - Road
- `2` - Rail
- `3` - Air
- `4` - Ship

**Response:**
```json
{
  "success": true,
  "data": {
    "ewbNo": 123456789012,
    "vehicleNo": "MH12CD5678",
    "updatedDate": "29/12/2024 10:30:00",
    "validUpto": "12/01/2025"
  }
}
```

---

### 4. Cancel E-Way Bill

**Endpoint:** `POST /e-waybill/cancel`

**Request Body:**
```json
{
  "ewbNo": 123456789012,
  "cancelRsnCode": "3",
  "cancelRmrk": "Data entry mistake in invoice number"
}
```

**Cancel Reason Codes:**
- `1` - Duplicate
- `2` - Order Cancelled
- `3` - Data Entry Mistake
- `4` - Others

**Response:**
```json
{
  "success": true,
  "data": {
    "ewbNo": 123456789012,
    "cancelDate": "29/12/2024"
  }
}
```

**Important:** E-Way Bills can only be cancelled within 24 hours of generation.

---

### 5. Extend Validity

**Endpoint:** `POST /e-waybill/extend-validity`

**Request Body:**
```json
{
  "ewbNo": 123456789012,
  "vehicleNo": "KA01AB1234",
  "fromPlace": "Hubli",
  "fromState": 29,
  "remainingDistance": 300,
  "extnRsnCode": "3",
  "extnRemarks": "Vehicle breakdown - repairs completed",
  "consignmentStatus": "M",
  "transMode": "1"
}
```

**Extension Reason Codes:**
- `1` - Natural Calamity
- `2` - Law and Order Situation
- `3` - Transhipment
- `4` - Accident
- `5` - Others

**Consignment Status:**
- `M` - In Movement
- `T` - In Transit

**Response:**
```json
{
  "success": true,
  "data": {
    "ewbNo": 123456789012,
    "validUpto": "15/01/2025"
  }
}
```

---

### 6. Generate Consolidated E-Way Bill

**Endpoint:** `POST /e-waybill/consolidated`

**Request Body:**
```json
{
  "tripSheetNo": "TS-2024-001",
  "vehicleNo": "MH12AB1234",
  "fromPlace": "Mumbai",
  "fromState": 27,
  "transMode": "1",
  "ewbNos": [123456789012, 123456789013, 123456789014]
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "cewbNo": 987654321098,
    "cewbDate": "29/12/2024",
    "validUpto": "12/01/2025",
    "tripSheetEwbBills": [
      { "ewbNo": 123456789012, "status": "ACT" },
      { "ewbNo": 123456789013, "status": "ACT" },
      { "ewbNo": 123456789014, "status": "ACT" }
    ]
  }
}
```

---

### 7. Reject E-Way Bill (Recipient)

**Endpoint:** `POST /e-waybill/reject`

**Request Body:**
```json
{
  "ewbNo": 123456789012,
  "rejectReasonCode": "2",
  "rejectRemark": "Incorrect invoice details"
}
```

**Reject Reason Codes:**
- `1` - Duplicate
- `2` - Wrong Data

**Response:**
```json
{
  "success": true,
  "data": {
    "ewbNo": 123456789012,
    "rejectDate": "29/12/2024"
  }
}
```

---

### 8. Get E-Way Bills Generated by Others

**Endpoint:** `GET /e-waybill/generated-by-others?date=29/12/2024`

**Query Parameters:**
- `date` - Date in DD/MM/YYYY format

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "ewbNo": 123456789015,
      "ewbDate": "29/12/2024",
      "genGstin": "27AABCU9603R1ZM",
      "othPartyGstin": "29AABCU9603R1ZN",
      "trnType": "1",
      "docNo": "INV-001",
      "docDate": "29/12/2024",
      "totValue": 75000
    }
  ]
}
```

---

## üîÑ Async Queue Processing

### Queue Job Status

**Get Job Status:**
```typescript
import { getJobStatus } from '../queues/ewaybill-generation.queue';

const status = await getJobStatus('job-id');
console.log(status);
// {
//   status: 'completed',
//   progress: 100,
//   result: { ewbNo: 123456789012 },
//   error: null
// }
```

**Job States:**
- `waiting` - Job queued, waiting to start
- `active` - Job currently processing
- `completed` - Job completed successfully
- `failed` - Job failed (will retry)
- `not_found` - Job ID not found

---

## üóÉÔ∏è Database Schema Updates

Add these columns to your `invoices` table:

```sql
ALTER TABLE invoices
ADD COLUMN ewaybill_no BIGINT,
ADD COLUMN ewaybill_date VARCHAR(50),
ADD COLUMN ewaybill_valid_upto VARCHAR(50),
ADD COLUMN ewaybill_status VARCHAR(20),
ADD COLUMN vehicle_number VARCHAR(20),
ADD COLUMN transport_mode VARCHAR(1),
ADD COLUMN distance INTEGER;

CREATE INDEX idx_invoices_ewaybill_no ON invoices(ewaybill_no);
CREATE INDEX idx_invoices_ewaybill_status ON invoices(ewaybill_status);
```

---

## ‚ö†Ô∏è Error Handling

### Common Error Responses

```json
{
  "success": false,
  "message": "E-Way Bill generation failed",
  "error": {
    "errorCode": "2008",
    "message": "E-Way Bill cannot be cancelled after 24 hours"
  }
}
```

### Error Code Reference

| Code | Description | Solution |
|------|-------------|----------|
| 2002 | E-Way Bill already exists | Check if EWB already generated |
| 2003 | Invoice value below threshold | EWB not required for <‚Çπ50k |
| 2008 | Cannot cancel after 24 hours | Contact department for help |
| 2010 | Invalid GSTIN | Verify GSTIN format |
| 2015 | Already cancelled | EWB already cancelled |
| 2020 | E-Way Bill expired | Generate new EWB |
| 2025 | Invalid vehicle number | Check format (e.g., MH12AB1234) |
| 4001 | Authentication failed | Check credentials in .env |
| 4003 | Rate limit exceeded | Wait before retrying |

---

## üß™ Testing

### 1. Test E-Way Bill Generation

```bash
# Using cURL
curl -X POST http://localhost:3001/api/v1/e-waybill/generate \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "invoiceId": "test-invoice-id"
  }'
```

### 2. Test with Postman

```javascript
// Import this collection
{
  "info": {
    "name": "E-Way Bill API",
    "_postman_id": "12345",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Generate E-Way Bill",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{authToken}}"
          }
        ],
        "url": "{{baseUrl}}/e-waybill/generate",
        "body": {
          "mode": "raw",
          "raw": "{\n  \"invoiceId\": \"{{invoiceId}}\"\n}"
        }
      }
    }
  ]
}
```

### 3. Integration Tests

```typescript
// tests/ewaybill.test.ts
import request from 'supertest';
import app from '../src/app';

describe('E-Way Bill API', () => {
  let authToken: string;
  let invoiceId: string;

  beforeAll(async () => {
    // Get auth token
    const loginRes = await request(app)
      .post('/api/v1/auth/login')
      .send({ email: 'test@example.com', password: 'password' });
    authToken = loginRes.body.data.token;
  });

  test('should generate E-Way Bill', async () => {
    const response = await request(app)
      .post('/api/v1/e-waybill/generate')
      .set('Authorization', `Bearer ${authToken}`)
      .send({ invoiceId });

    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
    expect(response.body.data.ewbNo).toBeDefined();
  });

  test('should get E-Way Bill details', async () => {
    const ewbNo = 123456789012;
    const response = await request(app)
      .get(`/api/v1/e-waybill/${ewbNo}`)
      .set('Authorization', `Bearer ${authToken}`);

    expect(response.status).toBe(200);
    expect(response.body.data.ewbNo).toBe(ewbNo);
  });
});
```

---

## üîí Security Best Practices

1. **Encrypt Passwords**
   - Use crypto utility for password encryption
   - Never log plaintext credentials

2. **Rate Limiting**
   - Applied automatically (10 req/min)
   - Prevents API abuse

3. **Input Validation**
   - All inputs validated before API calls
   - GSTIN format validation
   - Vehicle number format validation

4. **Authentication**
   - JWT tokens expire after 6 hours
   - Automatic token refresh

5. **Logging**
   - All API calls logged
   - Sensitive data masked
   - Error tracking with context

---

## üìä Monitoring

### Log Files

```
logs/
‚îú‚îÄ‚îÄ combined.log     # All logs
‚îú‚îÄ‚îÄ error.log        # Error logs only
‚îî‚îÄ‚îÄ ewaybill.log     # E-Way Bill specific logs
```

### Key Metrics to Monitor

1. **Generation Success Rate**
   - Track successful vs failed generations
   - Alert on high failure rates

2. **API Response Times**
   - Monitor government API latency
   - Set alerts for slow responses

3. **Queue Health**
   - Monitor queue size
   - Track job processing times
   - Alert on stuck jobs

4. **Expiring E-Way Bills**
   - Track bills expiring in <4 hours
   - Send notifications to users

---

## üöÄ Production Deployment

### 1. Environment Setup

```bash
# Production .env
NODE_ENV=production
PORT=3001

# Use production E-Way Bill API
EWAYBILL_API_URL=https://api.ewaybillgst.gov.in

# Secure credentials
EWAYBILL_USERNAME=prod-username
EWAYBILL_PASSWORD=encrypted-password
EWAYBILL_GSTIN=your-production-gstin
```

### 2. Docker Deployment

```dockerfile
# Already configured in existing Dockerfile
# No changes needed - E-Way Bill service included
```

### 3. Health Checks

```bash
# Check E-Way Bill service health
curl http://localhost:3001/health

# Response should include:
# {
#   "redis": "connected",
#   "database": "connected",
#   "ewaybill": "ready"
# }
```

---

## üìö State Codes Reference

| State | Code | State | Code |
|-------|------|-------|------|
| Jammu and Kashmir | 1 | Maharashtra | 27 |
| Himachal Pradesh | 2 | Andhra Pradesh | 28 |
| Punjab | 3 | Karnataka | 29 |
| Chandigarh | 4 | Goa | 30 |
| Uttarakhand | 5 | Kerala | 32 |
| Haryana | 6 | Tamil Nadu | 33 |
| Delhi | 7 | Telangana | 36 |

[Full list in documentation]

---

## üÜò Troubleshooting

### Issue: Authentication Failed

**Error:** `4001 - Authentication failed`

**Solution:**
1. Check credentials in `.env` file
2. Verify GSTIN is registered on E-Way Bill portal
3. Ensure API access is enabled in portal
4. Check if using correct environment (sandbox vs production)

### Issue: Invalid GSTIN Format

**Error:** `2010 - Invalid GSTIN`

**Solution:**
1. GSTIN format: 2 digits (state) + 10 alphanumeric + 1 alphabet + 1 number + 1 alphabet
2. Example: `27AABCU9603R1ZM`
3. Verify customer GSTIN in database

### Issue: Vehicle Number Format Invalid

**Error:** `2025 - Invalid vehicle number`

**Solution:**
1. Format: `STATE_CODE + DISTRICT_CODE + SERIES + NUMBER`
2. Example: `MH12AB1234`
3. No spaces or special characters

### Issue: E-Way Bill Already Exists

**Error:** `2002 - E-Way Bill already exists`

**Solution:**
1. Check `ewaybill_no` field in invoice
2. If duplicate, cancel existing EWB first
3. If needed, update existing EWB instead

---

## üìñ Additional Resources

- **E-Way Bill Portal:** https://ewaybillgst.gov.in
- **API Documentation:** https://ewaybillgst.gov.in/api-docs
- **User Manual:** https://ewaybillgst.gov.in/user-manual
- **Help Desk:** 1800-103-4824
- **Email Support:** helpdesk@ewaybillgst.gov.in

---

## üìù Changelog

### Version 1.0.0 (December 2024)
- ‚úÖ Initial implementation
- ‚úÖ E-Way Bill generation
- ‚úÖ Vehicle management
- ‚úÖ Cancellation support
- ‚úÖ Validity extension
- ‚úÖ Consolidated E-Way Bills
- ‚úÖ Async queue processing
- ‚úÖ Complete error handling
- ‚úÖ Production-ready setup

---

## ü§ù Support

For backend issues:
- Check logs in `logs/` directory
- Enable debug mode: `LOG_LEVEL=debug`
- Review error codes in this documentation

For E-Way Bill portal issues:
- Contact E-Way Bill helpdesk
- Visit: https://ewaybillgst.gov.in/support

---

**Last Updated:** December 29, 2024  
**Version:** 1.0.0  
**Maintained by:** Your Organization
